<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat May 27 09:46:51 UTC 2023

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-5508] Request.evaluatePreconditions(Date, EntityTag) loses a non-null ResponseBuilder </title>
                <link>https://issues.apache.org/jira/browse/CXF-5508</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;The problem I reported in &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-4231&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CXF-4231&lt;/a&gt; is back since 2.7.6; we noticed when upgrading to 2.7.8. See also &lt;a href=&quot;https://fisheye6.atlassian.com/browse/cxf/branches/2.7.x-fixes/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/impl/RequestImpl.java?r2=1503661&amp;amp;r=1494596&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://fisheye6.atlassian.com/browse/cxf/branches/2.7.x-fixes/rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/impl/RequestImpl.java?r2=1503661&amp;amp;r=1494596&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The concrete change/problematic part: if (rb != null) { =&amp;gt; if (rb == null) {&lt;/p&gt;

&lt;p&gt;Any chance for a fix in the next release?&lt;/p&gt;</description>
                <environment></environment>
        <key id="12690078">CXF-5508</key>
            <summary>Request.evaluatePreconditions(Date, EntityTag) loses a non-null ResponseBuilder </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sergey_beryozkin">Sergey Beryozkin</assignee>
                                    <reporter username="jengehau">Jan Engehausen</reporter>
                        <labels>
                    </labels>
                <created>Tue, 21 Jan 2014 18:18:01 +0000</created>
                <updated>Fri, 11 Jul 2014 12:50:55 +0000</updated>
                            <resolved>Fri, 24 Jan 2014 18:21:09 +0000</resolved>
                                    <version>2.7.6</version>
                                    <fixVersion>2.6.12</fixVersion>
                    <fixVersion>2.7.9</fixVersion>
                    <fixVersion>3.0.0-milestone2</fixVersion>
                                    <component>JAX-RS</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13878564" author="sergey_beryozkin" created="Wed, 22 Jan 2014 11:50:55 +0000"  >&lt;p&gt;I&apos;m pretty sure the last change came after I did some TCK work,&lt;/p&gt;

&lt;p&gt;So we have&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; ResponseBuilder evaluatePreconditions(Date lastModified, EntityTag eTag) {
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ResponseBuilder rb = evaluatePreconditions(eTag);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (rb == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
            &lt;span class=&quot;code-comment&quot;&gt;// the ETag conditions match; so now conditions &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; last modified must match
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; evaluatePreconditions(lastModified);
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
            &lt;span class=&quot;code-comment&quot;&gt;// the ETag conditions &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not match, so last modified should be ignored
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// see http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html (section 14.26 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-quote&quot;&gt;&quot;If-None-Match&quot;&lt;/span&gt;, behaviour not specified &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;If-Match&quot;&lt;/span&gt;, section 14.24)
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and the relevant text:&lt;/p&gt;

&lt;p&gt;&quot;If none of the entity tags match, then the server MAY perform the requested method as if the If-None-Match header field did not exist, but MUST also ignore any If-Modified-Since header field(s) in the request. That is, &lt;b&gt;if no entity tags match, then the server MUST NOT return a 304 (Not Modified) response&lt;/b&gt;.&quot;&lt;/p&gt;

&lt;p&gt;The code above will ignore If-Modified-Since if none of the entity tags match, i.e, if they match, then ResponseBuilder is null, and the dates are checked, but if they do not match then null is returned.&lt;br/&gt;
Where is the problem ?&lt;/p&gt;

&lt;p&gt;Sergey&lt;/p&gt;</comment>
                            <comment id="13880074" author="jengehau" created="Thu, 23 Jan 2014 16:57:11 +0000"  >&lt;p&gt;Hello Sergey, sorry for responding so slowly. I have to check our code at work once more, at the moment it appears that our initial interpretation is wrong. &lt;a href=&quot;http://docs.oracle.com/javaee/6/api/javax/ws/rs/core/Request.html#evaluatePreconditions%28javax.ws.rs.core.EntityTag%29&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://docs.oracle.com/javaee/6/api/javax/ws/rs/core/Request.html#evaluatePreconditions%28javax.ws.rs.core.EntityTag%29&lt;/a&gt; says that it returns non-null if the preconditions are not met. In our case we send a If-None-Match with the previously obtained ETag value and an If-Modified-Since with the previously obtained modification date. Reading your response and the JavaDoc I&apos;d say the current behaviour is correct. But please let me check this with the our implementation - I&apos;ll update the issue once more tomorrow. &lt;/p&gt;

&lt;p&gt;Thank you for looking into this!&lt;/p&gt;</comment>
                            <comment id="13880759" author="jengehau" created="Fri, 24 Jan 2014 06:25:31 +0000"  >&lt;p&gt;Hi Sergey,&lt;/p&gt;

&lt;p&gt;okay I still think there&apos;s an issue here: We&apos;re using &lt;a href=&quot;http://docs.oracle.com/javaee/6/api/javax/ws/rs/core/Request.html#evaluatePreconditions%28java.util.Date,%20javax.ws.rs.core.EntityTag%29&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://docs.oracle.com/javaee/6/api/javax/ws/rs/core/Request.html#evaluatePreconditions%28java.util.Date,%20javax.ws.rs.core.EntityTag%29&lt;/a&gt; and pass in a weak ETag value (with &lt;tt&gt;If-None-Match&lt;/tt&gt; header) and the last modified timestamp (with &lt;tt&gt;If-Modified-Since&lt;/tt&gt; header) - the values are obtained from a previous request. Neither ETag value nor timestamp have changed. In my opinion the preconditions are &lt;b&gt;not&lt;/b&gt; met; ETag values match, but we say &quot;send request if ETag does not match or resource has been modified&quot;, in this case a non-&lt;tt&gt;null&lt;/tt&gt; value should be returned by &lt;tt&gt;evaluatePreconditions(Date, EntityTag)&lt;/tt&gt; - currently &lt;tt&gt;null&lt;/tt&gt; is returned, making us send a completely fresh response instead of status code 304.&lt;br/&gt;
What do you think?&lt;/p&gt;

&lt;p&gt;Kind regards,&lt;br/&gt;
Jan&lt;/p&gt;</comment>
                            <comment id="13881164" author="sergey_beryozkin" created="Fri, 24 Jan 2014 17:18:11 +0000"  >&lt;p&gt;Hi Jan,&lt;/p&gt;

&lt;p&gt;I&apos;ve looked at &lt;a href=&quot;http://tools.ietf.org/search/draft-ietf-httpbis-p4-conditional-25#section-3.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://tools.ietf.org/search/draft-ietf-httpbis-p4-conditional-25#section-3.1&lt;/a&gt;.&lt;br/&gt;
So,&lt;br/&gt;
&quot; When a client desires to update one or more&lt;br/&gt;
   stored responses that have entity-tags, the client SHOULD generate an&lt;br/&gt;
   If-None-Match header field containing a list of those entity-tags&lt;br/&gt;
   when making a GET request; this allows recipient servers to send a&lt;br/&gt;
   304 (Not Modified) response to indicate when one of those stored&lt;br/&gt;
   responses &lt;b&gt;matches&lt;/b&gt; the selected representation.&quot;&lt;/p&gt;

&lt;p&gt;In other words, the server sends a new representation if we have no matches.&lt;br/&gt;
I think it is correct, right ?&lt;/p&gt;

&lt;p&gt;In your case you do have tags matching. And ResponseImpl.evaluateIfNonMatch() returns null to indicate a match which is wrong, if we have a match in If-None-Match case then it means we do need a non-null ResponseBuilder to suggest that no resources have been modified. So I think you are right, the only thing is that the fix needs to be done inside ResponseImpl.evaluateIfNonMatch(), it should return the opposite value of the matching result...  &lt;/p&gt;

&lt;p&gt;Thanks, Sergey&lt;/p&gt;</comment>
                            <comment id="13881187" author="sergey_beryozkin" created="Fri, 24 Jan 2014 17:39:10 +0000"  >&lt;p&gt;I&apos;m getting confused now. &lt;br/&gt;
RequestImpl.evaluateIfNonMatch does return a non-null Response builder if the tags match. This is exactly correct as per the analysis above. So the JAX-RS code should get a non-null RB and return it.&lt;br/&gt;
Therefore the problem in your case appears to be to do with the fact that the entity tags &lt;b&gt;do not match&lt;/b&gt; which can explain why a null response builder is returned but you said above the ETags do match.&lt;/p&gt;

&lt;p&gt;What exactly happens in your case ?  &lt;/p&gt;

&lt;p&gt;Thanks, Sergey&lt;/p&gt;</comment>
                            <comment id="13881204" author="sergey_beryozkin" created="Fri, 24 Jan 2014 17:52:54 +0000"  >&lt;p&gt;The problem is still within the CXF code though, it is retuning &apos;null&apos; in the else branch which is problem, we should return the response builder value&lt;/p&gt;</comment>
                            <comment id="13881228" author="sergey_beryozkin" created="Fri, 24 Jan 2014 18:08:30 +0000"  >&lt;p&gt;Dates should be checked if ResponseBuilder is null - this is actually correct. The problem is that if ResponseBuilder is not null we still lose it and return null.&lt;/p&gt;</comment>
                            <comment id="13882592" author="jengehau" created="Mon, 27 Jan 2014 06:07:28 +0000"  >&lt;p&gt;Good morning Sergey,&lt;/p&gt;

&lt;p&gt;I&apos;ve tested 2.7.9-SNAPSHOT but unfortunately another scenario we test is not working any more now: Instead of a matching ETag value we send a non-matching one (e.g. &quot;W/does-not-match&quot;, &lt;tt&gt;If-None-Match&lt;/tt&gt;) and a matching last modified time stamp (same as from the original response, &lt;tt&gt;If-Modified-Since&lt;/tt&gt;). In 2.7.5, and to my expectation, this must return status code 200 (OK), a new response - because the ETags differ.&lt;/p&gt;

&lt;p&gt;So to summarize: We have the service generate the same ETag and last modification time stamp returning all the time, and we have the following tests:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;send &lt;em&gt;same ETag value&lt;/em&gt; for &lt;tt&gt;If-None-Match&lt;/tt&gt;, &lt;em&gt;same last modification date&lt;/em&gt; for &lt;tt&gt;If-Modified-Since&lt;/tt&gt; - we expect 304 (not modified)&lt;/li&gt;
	&lt;li&gt;send &lt;em&gt;different ETag value&lt;/em&gt; for &lt;tt&gt;If-None-Match&lt;/tt&gt;, &lt;em&gt;same last modification date&lt;/em&gt; for &lt;tt&gt;If-Modified-Since&lt;/tt&gt; - we expect 200 (ok, new response)&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I think these are valid expectations, do you agree?&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Jan&lt;/p&gt;</comment>
                            <comment id="13882729" author="sergey_beryozkin" created="Mon, 27 Jan 2014 10:23:13 +0000"  >&lt;p&gt;Hi&lt;/p&gt;

&lt;p&gt;So 1. is working, right ? If-None-Match value matches the tag, so we get a non-null ResponseBuilder and 304, ignoring the dates.&lt;br/&gt;
2: the tags do not match, we get a null ResponseBuilder and proceed to a Date check, you have the same If-Modified-Since value and the provided Date, so the secondary check returns 304.&lt;/p&gt;

&lt;p&gt;So it is about the data comparisons, and in case of If-Modified-Since if the values match it&apos;s a non-null RB. &lt;/p&gt;

&lt;p&gt;That appears to be correct to me, where do you see the contradiction ?&lt;/p&gt;

&lt;p&gt;Cheers, Sergey&lt;/p&gt;</comment>
                            <comment id="13882785" author="jengehau" created="Mon, 27 Jan 2014 12:33:36 +0000"  >&lt;p&gt;Hi Sergey,&lt;br/&gt;
right 1. is working, 2. is not. I think we put the test in, because there is something in the spec about it, see &lt;a href=&quot;http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html&lt;/a&gt; section 14.26:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;If none of the entity tags match, then the server MAY perform the requested method as if the If-None-Match header field did not exist, but MUST also ignore any If-Modified-Since header field(s) in the request. &lt;b&gt;That is, if no entity tags match, then the server MUST NOT return a 304 (Not Modified) response.&lt;/b&gt;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Kind regards,&lt;br/&gt;
Jan&lt;/p&gt;</comment>
                            <comment id="13882790" author="sergey_beryozkin" created="Mon, 27 Jan 2014 12:45:35 +0000"  >&lt;p&gt;Hi Jan,&lt;br/&gt;
I think in this case you have to use a single parameter method,&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://docs.oracle.com/javaee/6/api/javax/ws/rs/core/Request.html#evaluatePreconditions(javax.ws.rs.core.EntityTag&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://docs.oracle.com/javaee/6/api/javax/ws/rs/core/Request.html#evaluatePreconditions(javax.ws.rs.core.EntityTag&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;otherwise, if we did it as per your suggestion then in the method accepting two parameters, Date &lt;b&gt;will never be used&lt;/b&gt;. In fact, I&apos;m not seeing anything like &quot;MUST NOT&quot; in the latest HTTP spec effort:&lt;br/&gt;
&lt;a href=&quot;http://tools.ietf.org/search/draft-ietf-httpbis-p4-conditional-25#section-6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://tools.ietf.org/search/draft-ietf-httpbis-p4-conditional-25#section-6&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I think all is good now. If you do not want to use a secondary Date check then simply do Request.evaluatePreconditions(EntityTag)&lt;/p&gt;

&lt;p&gt;Thanks, Sergey&lt;/p&gt;
</comment>
                            <comment id="13882795" author="jengehau" created="Mon, 27 Jan 2014 13:02:38 +0000"  >&lt;p&gt;Hi Sergey,&lt;br/&gt;
alright, we&apos;ll think about that. The draft of the spec of course is not &quot;in the wild yet&quot;, though &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; - by the way, is there any planned date for the release of 2.7.9?&lt;br/&gt;
Thanks, and all the best,&lt;br/&gt;
Jan&lt;/p&gt;</comment>
                            <comment id="13882804" author="sergey_beryozkin" created="Mon, 27 Jan 2014 13:30:42 +0000"  >&lt;p&gt;Sure, the latest draft is still a draft, but I reckon a lot of HTTP 1.1 related text improvements based on the years of practice have made into it. That said, in this case, it is more of a Java issue, because using a 2-parameter method means the application code actually expects a secondary check if the primary one returns null &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;2.7.9 should be out hopefully in the next couple of weeks&lt;/p&gt;

&lt;p&gt;Thanks, Sergey&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>369035</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 18 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1rlun:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>369340</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>