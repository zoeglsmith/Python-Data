<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat May 27 09:47:41 UTC 2023

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-8051] Request gets corrupted when calling a stateful streamed secure conversation</title>
                <link>https://issues.apache.org/jira/browse/CXF-8051</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;The request to a streamed secure conversation web service gets corrupted if the service (.NET WCF) is configured as stateless (with a stateful token carrying the state in soap cookies). If the service as configured as stateful (no soap cookies), the request is valid.&lt;/p&gt;

&lt;p&gt;Updated 2nd time: When the request is streamed, CXF doesn&apos;t stream the payload of the content of the token cookie, and the reference from the cookie is &quot;unresolved&quot;. When the request is not-streamed, the cookie payload is included as base64 inside the cookie element, and everything works fine. The attached formatted requests EcBad.txt (failing from CXF) and EcGood.txt (valid request from a .NET WCF client) show the issue.&lt;/p&gt;</description>
                <environment>&lt;p&gt;The request is running in a console application hosted in Netbeans on Windows Server 2012 R2. The service is a .NET WCF service on Windows Server 2012 R2.&lt;/p&gt;</environment>
        <key id="13236339">CXF-8051</key>
            <summary>Request gets corrupted when calling a stateful streamed secure conversation</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="coheigea">Colm O hEigeartaigh</assignee>
                                    <reporter username="hn488">Henning Normann</reporter>
                        <labels>
                    </labels>
                <created>Wed, 29 May 2019 21:31:31 +0000</created>
                <updated>Wed, 14 Aug 2019 13:29:58 +0000</updated>
                            <resolved>Wed, 10 Jul 2019 09:18:08 +0000</resolved>
                                    <version>3.3.2</version>
                                    <fixVersion>3.3.3</fixVersion>
                                    <component>JAX-WS Runtime</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16851734" author="coheigea" created="Thu, 30 May 2019 10:52:32 +0000"  >&lt;p&gt;Is it possible to remove WS-Security to see if the error is caused in CXF itself or WSS4J/Santuario?&lt;/p&gt;</comment>
                            <comment id="16851863" author="hn488" created="Thu, 30 May 2019 13:28:14 +0000"  >&lt;p&gt;I thought that WS-Security was mandatory for a secure conversation and a stateful security token. The service works fine from CXF with streamed secure conversation with stateless security token. It also works fine for both stateful and stateless security tokens when the service is none-streamed. It also works for other bindings.&lt;/p&gt;</comment>
                            <comment id="16851873" author="coheigea" created="Thu, 30 May 2019 13:37:30 +0000"  >&lt;p&gt;Just to clarify, when you say &quot;streamed&quot; secure conversation are you using the WS-Security StAX implementation? e.g. setting ws-security.enable.streaming to true.&lt;/p&gt;</comment>
                            <comment id="16851922" author="hn488" created="Thu, 30 May 2019 14:19:03 +0000"  >&lt;p&gt;I don&apos;t use&#160;&lt;font color=&quot;#333333&quot;&gt;WS-Security StAX&lt;/font&gt; (as far as I know).&lt;/p&gt;</comment>
                            <comment id="16852287" author="hn488" created="Thu, 30 May 2019 19:58:54 +0000"  >&lt;p&gt;By &quot;streamed&quot; I mean that the .NET WCF service is configured with TransferMode=streamed (rather than the default buffered). The service has operations for upload and download binary files. The request is corrupted by a number injected into the message - probably by an interceptor?&lt;/p&gt;</comment>
                            <comment id="16852738" author="coheigea" created="Fri, 31 May 2019 07:20:59 +0000"  >&lt;p&gt;Ah ok thanks. It certainly looks like a CXF bug, however we need some help to narrow down the issue. Could you try to debug through the interceptor chain to see where it is corrupting the header?&lt;/p&gt;</comment>
                            <comment id="16853082" author="hn488" created="Fri, 31 May 2019 14:37:21 +0000"  >&lt;p&gt;Hm, looks like there&apos;s a network component that corrupts the request. The request looks valid as seen from Fiddler when leaving the client machine, and a 3-digit number is injected when it&apos;s inspected by Wireshark on the server machine.&lt;/p&gt;</comment>
                            <comment id="16853180" author="dkulp" created="Fri, 31 May 2019 16:22:52 +0000"  >&lt;p&gt;That &quot;632&quot; is the size for the next chunk for the chunked transfer encoding.  Thus, it looks correct.    You could try turning off the chunking if the requests are relatively small (aka: not megabytes in size).  The middle layer network component might not then be fiddling with the chunking.   &lt;/p&gt;</comment>
                            <comment id="16854342" author="hn488" created="Mon, 3 Jun 2019 08:07:35 +0000"  >&lt;p&gt;Updated error observation: Debugging the service (ref attached payload EcBad.txt) shows that the problem is that the reference in the xop element in the security token cookie doesn&#8217;t match the content id for the binary payload:&lt;/p&gt;

&lt;p&gt;&amp;lt;xop:Include xmlns:xop=&quot;http://www.w3.org/2004/08/xop/include&quot; href=&lt;span class=&quot;error&quot;&gt;&amp;#91;cid:http://tempuri.org/1/636951518227439376&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Content-ID: &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;mailto:64c6803c-4493-425a-9288-3e79d845fc75-1@www.altinn.no&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;64c6803c-4493-425a-9288-3e79d845fc75-1@www.altinn.no&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/mail_small.gif&quot; height=&quot;12&quot; width=&quot;13&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;It&#8217;s expected that the content id should match the value after cid int the xop href. (At least that works for consumers written with other technologies than CXF.)&lt;/p&gt;</comment>
                            <comment id="16855587" author="coheigea" created="Tue, 4 Jun 2019 11:07:42 +0000"  >&lt;p&gt;I&apos;m wondering why the SCT has a Cookie that references the binary payload of the request at all?&lt;/p&gt;</comment>
                            <comment id="16855594" author="hn488" created="Tue, 4 Jun 2019 11:20:37 +0000"  >&lt;p&gt;The cookie has a reference only when there&apos;s a streamed service. I don&apos;t know the standards, but this is how it&apos;s implemented by .NET WCF, and it works for both .NET WCF consumers and other kind of consumers.&lt;/p&gt;</comment>
                            <comment id="16855603" author="coheigea" created="Tue, 4 Jun 2019 11:43:15 +0000"  >&lt;p&gt;Do you know if it matters what the href value is in the Cookie so long as it matches the attachment? It would be easier to change that value than to change the Content-ID of the attachment.&lt;/p&gt;</comment>
                            <comment id="16855616" author="hn488" created="Tue, 4 Jun 2019 11:53:29 +0000"  >&lt;p&gt;Not sure, but I assume it would work. Currently we get a generic error message from the request parser that the href is an invalid reference.&lt;/p&gt;</comment>
                            <comment id="16863232" author="coheigea" created="Thu, 13 Jun 2019 16:20:59 +0000"  >&lt;p&gt;You could try writing a custom interceptor to override the Cookie xop:Include value with the correct value from the attachment. I&apos;m not sure this is something CXF should handle out of the box, as the Cookie Element is something specific to Microsoft and not a standard value.&lt;/p&gt;</comment>
                            <comment id="16863387" author="hn488" created="Thu, 13 Jun 2019 19:02:50 +0000"  >&lt;p&gt;Sorry, I now see that the previous version of the EcGood.txt was not good. I&apos;ve replaced it now with a request that shows a valid request that demonstrates a correct reference. My understanding is that CXF produces an invalid post (invalid not only to Microsoft). But anyway, we will look at an interceptor.&lt;/p&gt;</comment>
                            <comment id="16868077" author="hn488" created="Wed, 19 Jun 2019 22:56:13 +0000"  >&lt;p&gt;See updated analysis in the &quot;Description&quot; field. The sample requests are formatted and resubmitted.&lt;/p&gt;</comment>
                            <comment id="16869665" author="coheigea" created="Fri, 21 Jun 2019 16:41:32 +0000"  >&lt;p&gt;For the streaming case, could I see the payload for the initial response that contains the SecurityContextToken? I guess what is happening is that the attachment is being discarded here for the streaming case, instead of being preserved and written out on the subsequent client call.&lt;/p&gt;</comment>
                            <comment id="16869808" author="hn488" created="Fri, 21 Jun 2019 19:01:18 +0000"  >&lt;p&gt;The response from the security token service is attached as&#160;ResponseFromSecurityTokenService.txt.&lt;/p&gt;</comment>
                            <comment id="16877001" author="coheigea" created="Tue, 2 Jul 2019 14:02:23 +0000"  >&lt;p&gt;I created a pull request for an initial attempt at solving this problem:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cxf/pull/564&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cxf/pull/564&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Here the code inlines any attachment bytes for a SecurityContextToken if MTOM is enabled. I can&apos;t test it though as I have no reproducible testcase. Any chance you could apply the change locally + see if it works (or if not where it fails)?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16877344" author="hn488" created="Tue, 2 Jul 2019 22:43:48 +0000"  >&lt;p&gt;Will do&lt;/p&gt;</comment>
                            <comment id="16878924" author="hn488" created="Fri, 5 Jul 2019 01:13:31 +0000"  >&lt;p&gt;It crashes when calling WSSecurityUtil.inlineAttachments in inlineAttachments: org.apache.cxf.interceptor.Fault: Attachment not found: &lt;span class=&quot;error&quot;&gt;&amp;#91;cid:http://tempuri.org/1/636978929316876635&amp;#93;&lt;/span&gt;. I&#8217;ll try to find a public test environment for you with a sample streamed service.&lt;/p&gt;</comment>
                            <comment id="16880538" author="coheigea" created="Mon, 8 Jul 2019 16:57:08 +0000"  >&lt;p&gt;A public test-case would be great. In the meantime, I updated the PR with another approach you could try. I think the current message it was trying to get the attachments from may have been the wrong message, so it&apos;s trying to get the attachments directly from the response context. If that doesn&apos;t work, then maybe the AttachmentInInterceptor is not firing for some reason on the STS call.&lt;/p&gt;</comment>
                            <comment id="16880788" author="hn488" created="Mon, 8 Jul 2019 23:27:49 +0000"  >&lt;p&gt;Now it works&#128522; I would expect the token payload to be MTOM for an MTOM service, but it doesn&#8217;t matter to us whether it&#8217;s inline base64 or MTOM. When do you think that the PR will be merged, and is there a target date for 3.3.3?&lt;/p&gt;</comment>
                            <comment id="16881064" author="coheigea" created="Tue, 9 Jul 2019 08:54:56 +0000"  >&lt;p&gt;Great! Before merging, I&apos;d like to try something else. Could you try the PR again? I merged a fix not to inline the attachment, but to copy it to the outbound message. I&apos;m not sure if I did the copying correctly though.&lt;/p&gt;</comment>
                            <comment id="16881545" author="hn488" created="Tue, 9 Jul 2019 21:06:27 +0000"  >&lt;p&gt;It works - the token payload is sent as MTOM, and the first service call succeeds. However, if a second call is made to the service, the token payload is missing. I assume (but haven&#8217;t tested) that the same issue is with inline token payload.&lt;/p&gt;</comment>
                            <comment id="16881839" author="coheigea" created="Wed, 10 Jul 2019 08:25:43 +0000"  >&lt;p&gt;OK I am going to revert the MTOM fix and just go with the inlining fix, as otherwise it gets too complicated. I&apos;ll merge the PR once testing passes. It&apos;d be great if you could then grab the latest CXF SNAPSHOTs and verify for sure if the issue is fixed or not.&lt;/p&gt;</comment>
                            <comment id="16882484" author="hn488" created="Wed, 10 Jul 2019 22:16:23 +0000"  >&lt;p&gt;Looks great&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12972267" name="EcBad.txt" size="5456" author="hn488" created="Wed, 19 Jun 2019 22:54:15 +0000"/>
                            <attachment id="12972268" name="EcGood.txt" size="6837" author="hn488" created="Wed, 19 Jun 2019 22:54:34 +0000"/>
                            <attachment id="12972473" name="ResponseFromSecurityTokenService.txt" size="6554" author="hn488" created="Fri, 21 Jun 2019 18:59:47 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 46 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z037eg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>