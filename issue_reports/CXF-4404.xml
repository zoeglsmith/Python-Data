<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat May 27 09:47:33 UTC 2023

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-4404] atomicity violation bugs because of misusing concurrent collections</title>
                <link>https://issues.apache.org/jira/browse/CXF-4404</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;My name is Yu Lin. I&apos;m a Ph.D. student in the CS department at&lt;br/&gt;
UIUC. I&apos;m currently doing research on mining Java concurrent library&lt;br/&gt;
misusages. I found some misusages of ConcurrentHashMap in CXF 2.6.1,&lt;br/&gt;
which may result in potential atomicity violation bugs or harm the&lt;br/&gt;
performance.&lt;/p&gt;

&lt;p&gt;The code below is a snapshot of the code in file&lt;br/&gt;
api/src/main/java/org/apache/cxf/common/util/ASMHelper.java from line&lt;br/&gt;
306 to 327.&lt;/p&gt;

&lt;p&gt;L306        public synchronized Class&amp;lt;?&amp;gt; defineClass(String name, byte bytes[]) {&lt;br/&gt;
L307            Class&amp;lt;?&amp;gt; ret = defined.get(name.replace(&apos;/&apos;, &apos;.&apos;));&lt;br/&gt;
L308            if (ret != null) &lt;/p&gt;
{
L309                return ret;
L310            }
&lt;p&gt;L311            if (name.endsWith(&quot;package-info&quot;)) &lt;/p&gt;
{
                    ...
L323            }
&lt;p&gt;L324            &lt;br/&gt;
L325            ret = super.defineClass(name.replace(&apos;/&apos;, &apos;.&apos;), bytes, 0, bytes.length);&lt;br/&gt;
L326            defined.put(name.replace(&apos;/&apos;, &apos;.&apos;), ret);&lt;br/&gt;
L327            return ret;&lt;/p&gt;

&lt;p&gt;In the code above, the synchronized key word at line 306 can be&lt;br/&gt;
removed if we use putIfAbsent at line 326. If we remove the&lt;br/&gt;
synchronized without using putIfAbsent, an atomicity violation may&lt;br/&gt;
occur between lines &amp;lt;310 and 326&amp;gt;: Suppose a thread T1 executes line&lt;br/&gt;
307 and finds out the concurrent hashmap dose not contain the key&lt;br/&gt;
&quot;name.replace(&apos;/&apos;,&apos;.&apos;)&quot;. Before it gets to execute line 326, another&lt;br/&gt;
thread T2 puts a pair &amp;lt;name.replace(&apos;/&apos;,&apos;.&apos;), v&amp;gt; in the concurrent&lt;br/&gt;
hashmap &quot;defined&quot;. Now thread T1 resumes execution and it will&lt;br/&gt;
overwrite the value written by thread T2. Thus, the code no longer&lt;br/&gt;
preserves the &quot;put-if-absent&quot; semantics. However, such atomicity&lt;br/&gt;
violation bug can be eliminated by using putIfAbsent at line 326 (see&lt;br/&gt;
the patch).&lt;/p&gt;

&lt;p&gt;I found some similar misusages in other files:&lt;/p&gt;

&lt;p&gt;In&lt;br/&gt;
api/src/main/java/org/apache/cxf/configuration/spring/AbstractSpringBeanMap.java,&lt;br/&gt;
synchronized key word at line 67 can be removed by using putIfAbsent&lt;br/&gt;
at line 71. Also, atomicity violations may occur when T2 removes key&lt;br/&gt;
&quot;key&quot; from the concurrent hashmap &quot;putStore&quot; before T1 executes line&lt;br/&gt;
155; or T2 puts a pair &amp;lt;(X)key, v&amp;gt; to &quot;putStore&quot; before T1 executes&lt;br/&gt;
line 158.&lt;/p&gt;

&lt;p&gt;In api/src/main/java/org/apache/cxf/endpoint/ClientImpl.java, an&lt;br/&gt;
atomicity violation may occur when thread T2 removes key&lt;br/&gt;
&quot;THREAD_LOCAL_REQUEST_CONTEXT&quot; from the concurrent hashmap&lt;br/&gt;
&quot;currentRequestContext&quot; before thread T1 executes line 303.&lt;/p&gt;

&lt;p&gt;In api/src/main/java/org/apache/cxf/helpers/HttpHeaderHelper.java, an&lt;br/&gt;
atomicity violation may occur when thread T2 puts a pair &amp;lt;enc, v&amp;gt; to&lt;br/&gt;
concurrent hashmap &quot;encodings&quot; before T1 executes line 127.&lt;/p&gt;

&lt;p&gt;In&lt;br/&gt;
rt/core/src/main/java/org/apache/cxf/bus/osgi/CXFExtensionBundleListener.java,&lt;br/&gt;
an atomicity violation may occur when thread T2 puts a pair&lt;br/&gt;
&amp;lt;bundle.getBundleId(), v&amp;gt; to concurrent hashmap &quot;extensions&quot; before T1&lt;br/&gt;
executes line 93.&lt;/p&gt;

&lt;p&gt;In&lt;br/&gt;
rt/features/clustering/src/main/java/org/apache/cxf/clustering/FailoverTargetSelector.java,&lt;br/&gt;
synchronized key word at line 76 can be removed by using putIfAbsent&lt;br/&gt;
at line 91.&lt;/p&gt;

&lt;p&gt;In&lt;br/&gt;
rt/frontend/jaxrs/src/main/java/org/apache/cxf/jaxrs/model/ClassResourceInfo.java,&lt;br/&gt;
if another thread T2 puts a pair &amp;lt;key, v&amp;gt; into concurrent hashmap&lt;br/&gt;
&quot;subResources&quot; before thread T1 executes line 136, the &quot;cri&quot; in T1&lt;br/&gt;
won&apos;t be put into &quot;subResources&quot; at line 136. In this case, the&lt;br/&gt;
&quot;getSubResource&quot; method returns the wrong &quot;cri&quot;.&lt;/p&gt;

&lt;p&gt;In&lt;br/&gt;
rt/rs/extensions/providers/src/main/java/org/apache/cxf/jaxrs/provider/json/JSONProvider.java,&lt;br/&gt;
an atomicity violation may occur when thread T2 removes key&lt;br/&gt;
&quot;qname.getNamespaceURI()&quot; from the concurrent hashmap &quot;namespaceMap&quot;&lt;br/&gt;
before thread T1 executes line 405. Another atomicity violation is&lt;br/&gt;
when thread T2 puts a pair &amp;lt;namespace, v&amp;gt; to concurrent hashmap&lt;br/&gt;
&quot;namespaceMap&quot; before T1 executes line 530.&lt;/p&gt;

&lt;p&gt;In&lt;br/&gt;
rt/transports/http-jetty/src/main/java/org/apache/cxf/transport/http_jetty/JettyHTTPServerEngineFactory.java,&lt;br/&gt;
synchronized key word at line 107 can be removed by using putIfAbsent&lt;br/&gt;
at line 118.&lt;/p&gt;

&lt;p&gt;In&lt;br/&gt;
rt/transports/local/src/main/java/org/apache/cxf/transport/local/LocalTransportFactory.java,&lt;br/&gt;
an atomicity violation may occur when thread T2 puts a pair &amp;lt;addr, v&amp;gt;&lt;br/&gt;
to concurrent hashmap &quot;destinations&quot; before T1 executes line 128.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12596841">CXF-4404</key>
            <summary>atomicity violation bugs because of misusing concurrent collections</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ffang">Freeman Yue Fang</assignee>
                                    <reporter username="jacklondongood">Yu Lin</reporter>
                        <labels>
                            <label>patch</label>
                    </labels>
                <created>Mon, 2 Jul 2012 22:54:23 +0000</created>
                <updated>Tue, 28 Aug 2012 17:44:39 +0000</updated>
                            <resolved>Fri, 6 Jul 2012 06:22:36 +0000</resolved>
                                    <version>2.6.1</version>
                                    <fixVersion>2.6.2</fixVersion>
                    <fixVersion>2.7</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="1814400">504h</timeoriginalestimate>
                            <timeestimate seconds="1814400">504h</timeestimate>
                                        <comments>
                            <comment id="13405415" author="jacklondongood" created="Mon, 2 Jul 2012 22:58:28 +0000"  >&lt;p&gt;This is a patch that fixes the atomicity violation problem.&lt;/p&gt;</comment>
                            <comment id="13405605" author="ffang" created="Tue, 3 Jul 2012 04:11:35 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;Just one issue, the rt/core/src/main/java/org/apache/cxf/bus/osgi/CXFExtensionBundleListener.java change should be&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;@@ -90,7 +90,10 @@
         List&amp;lt;Extension&amp;gt; list = extensions.get(bundle.getBundleId());
         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (list == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
             list = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CopyOnWriteArrayList&amp;lt;Extension&amp;gt;();
-            extensions.put(bundle.getBundleId(), list);
+            List&amp;lt;Extension&amp;gt; preList = extensions.putIfAbsent(bundle.getBundleId(), list);
+            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (preList != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;) {
+                list = preList;
+            }
         }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;to ensure we won&apos;t lost extensions in a pre-saved list&lt;/p&gt;

&lt;p&gt;Also correct checkstyle.&lt;br/&gt;
Thanks for the patch&lt;br/&gt;
Freeman&lt;/p&gt;</comment>
                            <comment id="13407737" author="ffang" created="Fri, 6 Jul 2012 06:22:36 +0000"  >&lt;p&gt;Apply patch on behalf of Yu Lin with thanks&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12534473" name="cxf-2.6.1.patch" size="11702" author="jacklondongood" created="Mon, 2 Jul 2012 22:58:28 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10062"><![CDATA[Moderate]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>244788</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 48 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i05tu7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>31931</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>