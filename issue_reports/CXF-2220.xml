<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat May 27 09:46:54 UTC 2023

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-2220] Heavily reused &quot;default&quot; Work Queue Problem</title>
                <link>https://issues.apache.org/jira/browse/CXF-2220</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;Hi CXF Team,&lt;/p&gt;

&lt;p&gt;  We&apos;re fighting with threading+classloading related issues when testing JBossWS-CXF integration.&lt;br/&gt;
The problematic part is WorkQueueManagerImpl.getAutomaticWorkQueue() method that&lt;br/&gt;
is reused in the following three places in CXF code base.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;/home/opalka&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;/home/opalka/THIRDPARTY/CXF/SVN/tags/cxf-2.2.1&amp;#93;&lt;/span&gt;&amp;gt;grep -r getAutomaticWorkQueue * | grep -v &quot;\.svn&quot; | grep -v Test | grep -v workqueue&lt;br/&gt;
rt/core/src/main/java/org/apache/cxf/interceptor/OneWayProcessorInterceptor.java:                .getAutomaticWorkQueue().execute(new Runnable() {&lt;br/&gt;
rt/transports/http/src/main/java/org/apache/cxf/transport/http/HTTPConduit.java:                    queue = mgr.getAutomaticWorkQueue();&lt;br/&gt;
rt/ws/addr/src/main/java/org/apache/cxf/ws/addressing/ContextUtils.java:                           :  workQueueManager.getAutomaticWorkQueue();&lt;/p&gt;

&lt;p&gt;This method constructs &quot;default&quot; worker threads pool on first request and this thread pool is &lt;br/&gt;
heavily reused by CXF for other applications. We see the following problem on our server side:&lt;/p&gt;

&lt;p&gt;When this &quot;default&quot; worker threads pool gets constructed all its worker threads have associated&lt;br/&gt;
classloader of the calling thread (in our case calling thread has associated web application classloader).&lt;br/&gt;
This is how Java threads are constructed (they inherit the parent thread classloader).&lt;br/&gt;
This thread pool is heavily reused by CXF for other applications.&lt;br/&gt;
The problem will appear when we undeploy the web application (the one that worker threads have associated&lt;br/&gt;
classloader with). After undeployment of that archive all worker threads will throw ClassNotFoundException when passed&lt;br/&gt;
jobs will try to do something with the classloader. Here&apos;s the sample stack trace:&lt;/p&gt;

&lt;p&gt;2009-05-12 09:30:14,923 INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.cxf.phase.PhaseInterceptorChain:70&amp;#93;&lt;/span&gt; (pool-13-thread-2) Interceptor has thrown exception, unwinding now&lt;br/&gt;
org.apache.cxf.binding.soap.SoapFault: Problems creating SAAJ object model&lt;br/&gt;
	at org.apache.cxf.binding.soap.saaj.SAAJInInterceptor.handleMessage(SAAJInInterceptor.java:165)&lt;br/&gt;
	at org.apache.cxf.binding.soap.saaj.SAAJInInterceptor.handleMessage(SAAJInInterceptor.java:67)&lt;br/&gt;
	at org.apache.cxf.phase.PhaseInterceptorChain.doIntercept(PhaseInterceptorChain.java:236)&lt;br/&gt;
	at org.apache.cxf.endpoint.ClientImpl.onMessage(ClientImpl.java:641)&lt;br/&gt;
	at org.apache.cxf.endpoint.ClientImpl$1$1.run(ClientImpl.java:722)&lt;br/&gt;
	at org.apache.cxf.workqueue.SynchronousExecutor.execute(SynchronousExecutor.java:37)&lt;br/&gt;
	at org.apache.cxf.endpoint.ClientImpl$1.onMessage(ClientImpl.java:720)&lt;br/&gt;
	at org.apache.cxf.transport.http.HTTPConduit$WrappedOutputStream.handleResponseInternal(HTTPConduit.java:2134)&lt;br/&gt;
	at org.apache.cxf.transport.http.HTTPConduit$WrappedOutputStream$1.run(HTTPConduit.java:2018)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:650)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:675)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:595)&lt;br/&gt;
Caused by: javax.xml.soap.SOAPException: Unable to create message factory for SOAP: Unable to create SAAJ meta-factoryProvider com.sun.xml.messaging.saaj.soap.SAAJMetaFactoryImpl could not be instantiated: java.lang.IllegalStateException: BaseClassLoader@298b744f&lt;/p&gt;
{vfszip:/opt/svn/jbossas/tags/JBoss_5_0_1_GA/build/output/jboss-5.0.1.GA/server/cts/tmp/jsr88/WSAsyncHandler_wsservlet_vehicle.ear/WSAsyncHandler_wsservlet_vehicle_web.war/}
&lt;p&gt; classLoader is not connected to a domain (probably undeployed?) for class com.sun.xml.messaging.saaj.soap.SAAJMetaFactoryImpl&lt;br/&gt;
	at javax.xml.soap.MessageFactory.newInstance(Unknown Source)&lt;br/&gt;
	at org.apache.cxf.binding.soap.saaj.SAAJInInterceptor.getFactory(SAAJInInterceptor.java:84)&lt;br/&gt;
	at org.apache.cxf.binding.soap.saaj.SAAJInInterceptor.handleMessage(SAAJInInterceptor.java:96)&lt;br/&gt;
	... 11 more&lt;/p&gt;

&lt;p&gt;To prevent these kinds of problems I had to implement the patches to don&apos;t reuse &quot;default&quot; worker threads pool.&lt;br/&gt;
See attached HttpConduit.java patch how to achieve that.&lt;/p&gt;

&lt;p&gt;Could you apply the patch for all three CXF souce files where &quot;default&quot; worker threads pool is reused?&lt;/p&gt;

&lt;p&gt;The solution is to use e.g. Executors.newSingleThreadExecutor() instead of WorkQueueManagerImpl.getAutomaticWorkQueue() method.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;JBossWS Team&lt;/p&gt;

&lt;p&gt;PS: BTW, it took many hours of heavy debugging to identify this issue &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12425473">CXF-2220</key>
            <summary>Heavily reused &quot;default&quot; Work Queue Problem</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dkulp">Daniel Kulp</assignee>
                                    <reporter username="opalka">Richard Opalka</reporter>
                        <labels>
                    </labels>
                <created>Thu, 14 May 2009 15:36:41 +0000</created>
                <updated>Thu, 4 Jun 2009 21:32:57 +0000</updated>
                            <resolved>Mon, 18 May 2009 13:37:14 +0000</resolved>
                                    <version>2.2.1</version>
                                    <fixVersion>2.2.2</fixVersion>
                    <fixVersion>2.1.6</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12709474" author="dkulp" created="Thu, 14 May 2009 17:18:57 +0000"  >
&lt;p&gt;I really don&apos;t think that switching to the Executors.newSingleThreadExecutor() is a good idea.   It completely defeats the purpose of having the work queue.    I really think we SHOULD be able to fix this in the AutomaticWorkQueueImpl.  &lt;/p&gt;

&lt;p&gt;I&apos;ve attached a patch (I&apos;ll probably commit to 2.2.x if tests pass with it) that does a bunch of modifications to the AWQI:&lt;/p&gt;

&lt;p&gt;1) Made it create it&apos;s own ThreadGroup - it tries to traverse up the parents of the current thread group to find the highest parent that it can use.   Thus, the resulting threads should be as close to &quot;system&quot; threads instead of application threads as possible.&lt;/p&gt;

&lt;p&gt;2) Creates a ThreadFactory around that group.   It will set the contextClassLoader for each thread it creates to the classloader of the AWQI, not any application context classloaders.   &lt;/p&gt;

&lt;p&gt;3) For each &quot;Runnable&quot; submitted to Execute, it wrappers it with a new Runnable that will make sure the contextClassLoader on the thread used to run the runnable is the same as the calling thread.    That should allow us to avoid modifying every place that something is submitted to the AWQI to have it do the classloader copy.&lt;/p&gt;

&lt;p&gt;I hope the combination of the three will fix the issue for you.   Could you give it a run through with your tests and let me know how it goes?&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="12710351" author="opalka" created="Mon, 18 May 2009 12:47:18 +0000"  >&lt;p&gt;I successfully verified the cxf2220.patch locally &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12383628">CXF-1243</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12408143" name="HTTPConduit.diff" size="1572" author="opalka" created="Thu, 14 May 2009 15:40:43 +0000"/>
                            <attachment id="12408148" name="cxf-2220.patch" size="7465" author="dkulp" created="Thu, 14 May 2009 17:18:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10062"><![CDATA[Moderate]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>113658</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 3 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i143iv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>232034</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>