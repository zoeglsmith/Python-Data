<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat May 27 09:45:15 UTC 2023

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-2985] Memory leak when initializing CXF throughSpring</title>
                <link>https://issues.apache.org/jira/browse/CXF-2985</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;As described in a comment of bug &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-2164&quot; title=&quot;CXFBusImpl never removed from ThreadLocal, generates permgen out of memory error after some redeployments&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CXF-2164&quot;&gt;&lt;del&gt;CXF-2164&lt;/del&gt;&lt;/a&gt;, there&apos;s still a case of memory leak produced by CXF when embedded into a web application and initialized through Spring.&lt;/p&gt;

&lt;p&gt;The problem is that cxf.xml declares the following bean:&lt;/p&gt;

&lt;p&gt;&amp;lt;bean id=&quot;cxf&quot; class=&quot;org.apache.cxf.bus.CXFBusImpl&quot;/&amp;gt;&lt;/p&gt;

&lt;p&gt;Here, the destroy-method is not declared. This means that when Sping shuts down the context, it does not call any shutdown method on the CXFBusImpl.&lt;/p&gt;

&lt;p&gt;The net result is the following:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Tomcat starts&lt;/li&gt;
	&lt;li&gt;Tomcat starts my web application&lt;/li&gt;
	&lt;li&gt;this declares a Spring web application context that gets parsed&lt;/li&gt;
	&lt;li&gt;at some point cxf.xml is parsed, so the bean named cxf is created and an org.apache.cxf.bus.CXFBusImpl instance is created using the constructor org.apache.cxf.bus.CXFBusImpl.CXFBusImpl(Map&amp;lt;Class, Object&amp;gt;), which causes the org.apache.cxf.BusFactory.localBus ThreadLocal to be assigned a value of this type, through a call to org.apache.cxf.BusFactory.possiblySetDefaultBus(Bus); I see that this happens in a thread called &quot;main&quot;&lt;/li&gt;
	&lt;li&gt;if I stop the web application, Spring closes down the context; however, as I said before, this does not cause any shutdown method of the cxf bean to be called&lt;/li&gt;
	&lt;li&gt;so there&apos;s no null-setting or removing operation of the org.apache.cxf.BusFactory.localBus ThreadLocal for the thread &quot;main&quot;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The problem of the use of a ThreadLocal is that even if the shutdown method od CXFBusImpl were called, the shutdown operation may be done in a thread which is different from the one in which the context had been created.&lt;/p&gt;

&lt;p&gt;As suggested by Daniel Kulp in the other report, maybe the best solution is to use a WeakHashMap&amp;lt;Thread, Bus&amp;gt; to keep the thread-bus relationships.&lt;br/&gt;
I&apos;m going to provide a patch.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12473668">CXF-2985</key>
            <summary>Memory leak when initializing CXF throughSpring</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dkulp">Daniel Kulp</assignee>
                                    <reporter username="mauromol">Mauro Molinari</reporter>
                        <labels>
                    </labels>
                <created>Thu, 9 Sep 2010 10:49:33 +0000</created>
                <updated>Wed, 2 Nov 2011 00:44:17 +0000</updated>
                            <resolved>Fri, 17 Sep 2010 02:35:40 +0000</resolved>
                                    <version>2.2.10</version>
                                    <fixVersion>2.2.11</fixVersion>
                                    <component>Bus</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12907593" author="mauromol" created="Thu, 9 Sep 2010 11:01:15 +0000"  >&lt;p&gt;This patch does the following:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;adds org.apache.cxf.bus.CXFBusImpl.shutdown() (which calls org.apache.cxf.bus.CXFBusImpl.shutdown(boolean)) and makes cxf.xml declare destroy-method=&quot;shutdown&quot;&lt;/li&gt;
	&lt;li&gt;replaces the ThreadLocal implementation of the localBus relationship in org.apache.cxf.BusFactory with a synchronized WeakHashMap&amp;lt;Thread, Bus&amp;gt;&lt;/li&gt;
	&lt;li&gt;adds the new method org.apache.cxf.BusFactory.clearDefaultBusForAnyThread(Bus) which removes any entry in the WeakHashMap that has a given bus as a value&lt;/li&gt;
	&lt;li&gt;makes org.apache.cxf.bus.CXFBusImpl.shutdown(boolean) also call that new method&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Please note that org.apache.cxf.BusFactory.getThreadDefaultBus(boolean) and org.apache.cxf.BusFactory.possiblySetDefaultBus(Bus) require synchronization because a concurrent call to org.apache.cxf.BusFactory.clearDefaultBusForAnyThread(Bus) may modify the map in the middle of those methods.&lt;/p&gt;

&lt;p&gt;I hope this helps.&lt;/p&gt;</comment>
                            <comment id="12910426" author="dkulp" created="Fri, 17 Sep 2010 02:35:40 +0000"  >
&lt;p&gt;Slightly modified patch applied.  Thanks!&lt;/p&gt;</comment>
                            <comment id="13141525" author="seumas.soltysik" created="Tue, 1 Nov 2011 20:10:58 +0000"  >&lt;p&gt;Any reason that this was not applied to 2.1.x? Or was 2.1.x already not supported by the time this fix was made?&lt;/p&gt;</comment>
                            <comment id="13141540" author="dkulp" created="Tue, 1 Nov 2011 20:30:39 +0000"  >&lt;p&gt;The last release of 2.1.x was on Jun 1st 2010 which was a few months before this.  So out of support by the time the bug was reported and fixed.&lt;/p&gt;</comment>
                            <comment id="13141805" author="seumas.soltysik" created="Wed, 2 Nov 2011 00:44:17 +0000"  >&lt;p&gt;Thanks Dan. That is what I thought.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12454202" name="Patch_CXF-2985.patch" size="4993" author="mauromol" created="Thu, 9 Sep 2010 11:01:15 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>47214</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 31 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0uz4n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>178832</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>