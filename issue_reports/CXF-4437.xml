<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat May 27 09:46:26 UTC 2023

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-4437] Stack Overflow exception in org.apache.cxf.endpoint.ClientImpl when logging set to FINE</title>
                <link>https://issues.apache.org/jira/browse/CXF-4437</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I can reproduce the issue in our code, but will probably struggle to&lt;br/&gt;
create a test case.  &lt;/p&gt;

&lt;p&gt;I have narrowed down the culprit (in 2.6.1) to org.apache.cxf.endpoint.ClientImpl line 636&lt;/p&gt;

&lt;p&gt;The method protected Object[] processResult(Message message,&lt;br/&gt;
                                   Exchange exchange,&lt;br/&gt;
                                   BindingOperationInfo oi,&lt;br/&gt;
                                   Map&amp;lt;String, Object&amp;gt; resContext)&lt;br/&gt;
throws Exception {&lt;/p&gt;

&lt;p&gt;And the code:&lt;/p&gt;

&lt;p&gt;if (LOG.isLoggable(Level.FINE)) &lt;/p&gt;
{
                    LOG.fine(&quot;set responseContext to be&quot; + resContext);
                }


&lt;p&gt;The code to add all the properties from the message to resContext, creates a recursive reference, because the message already has a reference to resContext.  This causes the logging to fail as when it tries to serialise the content of the map, it gets a stack overflow.&lt;/p&gt;

&lt;p&gt;The org.apache.cxf.invocation.context contains the ResponseContext and&lt;br/&gt;
the ResponseContext contains the org.apache.cxf.invocation.context&lt;/p&gt;

&lt;p&gt;To prove my hypothesis I added the following code to replace the log call:&lt;/p&gt;

&lt;p&gt;HashMap contextMap = (HashMap)&lt;br/&gt;
resContext.get(&quot;org.apache.cxf.invocation.context&quot;);&lt;br/&gt;
                        HashMap responseContextMap = (HashMap)&lt;br/&gt;
contextMap.get(&quot;ResponseContext&quot;);&lt;br/&gt;
                        HashMap secondContextMap = (HashMap)&lt;br/&gt;
responseContextMap.get(&quot;org.apache.cxf.invocation.context&quot;);&lt;br/&gt;
                        if (secondContextMap != null) &lt;/p&gt;
{
                                System.out.println(&quot;Oh boy here is the error!&quot;);
                        }

&lt;p&gt;And I got the Oh boy here is the error! message back.&lt;/p&gt;

&lt;p&gt;The original stack trace is:&lt;/p&gt;


&lt;p&gt;java.lang.StackOverflowError&lt;br/&gt;
        at java.util.HashMap$EntrySet.iterator(HashMap.java:950)&lt;br/&gt;
        at java.util.AbstractMap.toString(AbstractMap.java:478)&lt;br/&gt;
        at java.lang.String.valueOf(String.java:2826)&lt;br/&gt;
        at java.lang.StringBuilder.append(StringBuilder.java:115)&lt;br/&gt;
        at java.util.AbstractMap.toString(AbstractMap.java:490)&lt;br/&gt;
        at java.lang.String.valueOf(String.java:2826)&lt;br/&gt;
        at java.lang.StringBuilder.append(StringBuilder.java:115)&lt;br/&gt;
        at java.util.AbstractMap.toString(AbstractMap.java:490)&lt;br/&gt;
        at java.lang.String.valueOf(String.java:2826)&lt;br/&gt;
        at java.lang.StringBuilder.append(StringBuilder.java:115)&lt;br/&gt;
        at java.util.AbstractMap.toString(AbstractMap.java:490)&lt;br/&gt;
        at java.lang.String.valueOf(String.java:2826)&lt;br/&gt;
        at java.lang.StringBuilder.append(StringBuilder.java:115)&lt;br/&gt;
        at java.util.AbstractMap.toString(AbstractMap.java:490)&lt;br/&gt;
        at java.lang.String.valueOf(String.java:2826)&lt;br/&gt;
        at java.lang.StringBuilder.append(StringBuilder.java:115)&lt;br/&gt;
        at java.util.AbstractMap.toString(AbstractMap.java:490)&lt;br/&gt;
        at java.lang.String.valueOf(String.java:2826)&lt;br/&gt;
        at java.lang.StringBuilder.append(StringBuilder.java:115)&lt;br/&gt;
        at java.util.AbstractMap.toString(AbstractMap.java:490)&lt;br/&gt;
        at java.lang.String.valueOf(String.java:2826)&lt;br/&gt;
        at java.lang.StringBuilder.append(StringBuilder.java:115)&lt;br/&gt;
        at java.util.AbstractMap.toString(AbstractMap.java:490)&lt;br/&gt;
        at java.lang.String.valueOf(String.java:2826)&lt;br/&gt;
        at java.lang.StringBuilder.append(StringBuilder.java:115)&lt;br/&gt;
        at java.util.AbstractMap.toString(AbstractMap.java:490)&lt;br/&gt;
        at java.lang.String.valueOf(String.java:2826)&lt;br/&gt;
        at java.lang.StringBuilder.append(StringBuilder.java:115)&lt;br/&gt;
        at java.util.AbstractMap.toString(AbstractMap.java:490)&lt;/p&gt;

&lt;p&gt;&amp;lt;snip&amp;gt;&lt;/p&gt;</description>
                <environment>&lt;p&gt;JDK 1.6.0_32&lt;/p&gt;</environment>
        <key id="12599579">CXF-4437</key>
            <summary>Stack Overflow exception in org.apache.cxf.endpoint.ClientImpl when logging set to FINE</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="3" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">Major</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ay">Akitoshi Yoshida</assignee>
                                    <reporter username="pellcorp">Jason Pell</reporter>
                        <labels>
                    </labels>
                <created>Fri, 20 Jul 2012 05:19:10 +0000</created>
                <updated>Tue, 28 Aug 2012 17:44:40 +0000</updated>
                            <resolved>Fri, 27 Jul 2012 09:24:24 +0000</resolved>
                                    <version>2.6.1</version>
                                    <fixVersion>2.4.9</fixVersion>
                    <fixVersion>2.5.5</fixVersion>
                    <fixVersion>2.6.2</fixVersion>
                    <fixVersion>2.7</fixVersion>
                                    <component>Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13418926" author="pellcorp" created="Fri, 20 Jul 2012 05:21:13 +0000"  >&lt;p&gt;In addition in the same code I think the setContext method is not&lt;br/&gt;
actually logging what is expected.&lt;/p&gt;

&lt;p&gt;Should it be adding all the request context info to the message or vice versa?&lt;/p&gt;

&lt;p&gt;Should it be:&lt;br/&gt;
   message.putAll(ctx);&lt;/p&gt;

&lt;p&gt;Or:&lt;br/&gt;
ctx.putAll(message);&lt;/p&gt;

&lt;p&gt;As for the processResult logging?&lt;/p&gt;</comment>
                            <comment id="13420538" author="ay" created="Mon, 23 Jul 2012 10:22:35 +0000"  >&lt;p&gt;Hi Jason,&lt;br/&gt;
I think we can guard against this situation by not allowing the invocation context to be put into the response context but I am wondering how the invocation context was inserted into the response context in your case. &lt;/p&gt;

&lt;p&gt;Are you doing something particular in your code? For instance, copying the request message to the response message?&lt;br/&gt;
Thanks.&lt;br/&gt;
regards, aki&lt;/p&gt;</comment>
                            <comment id="13420605" author="dkulp" created="Mon, 23 Jul 2012 12:34:35 +0000"  >
&lt;p&gt;I&apos;m also wondering if it would make sense to just log the keySet instead of the whole map.... The values can contain things like passwords, credentials for security keysets, etc...   Maybe &quot;FINEST&quot; log everything.  Not really sure, but its a thought.&lt;/p&gt;</comment>
                            <comment id="13421000" author="pellcorp" created="Mon, 23 Jul 2012 22:32:46 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;Thanks for your comments. The problem occurs when we abort the outgoing chain and &lt;br/&gt;
Call the onMessage on the Message Observer. What we are not doing is creating a new Response message which. I guess is pretty stupid. I will change our code to do this and see if the issue goes away.&lt;/p&gt;</comment>
                            <comment id="13421271" author="ay" created="Tue, 24 Jul 2012 08:50:55 +0000"  >&lt;p&gt;Hi Jason,&lt;br/&gt;
that explains the reason. The request message contains the invocation context, whereas the response message does not. So, the current code that copies the response message properties into the response context should not create a recursive reference. However, if the request message is directly used as the response message, there will be a recursive reference.&lt;/p&gt;

&lt;p&gt;So, if you are not using the request message directly as the response message, this problem should not occur.&lt;/p&gt;

&lt;p&gt;@Dan,&lt;br/&gt;
to be on the protected side, we should change the code to not put the invocation context into the response context.&lt;br/&gt;
In addition, should we even get rid of this log line or log only the keys? I don&apos;t know if it is okay to log the context properties from the security point of view even if the level is set to FINEST. &lt;/p&gt;

&lt;p&gt;regards, aki&lt;/p&gt;</comment>
                            <comment id="13423765" author="ay" created="Fri, 27 Jul 2012 09:24:24 +0000"  >&lt;p&gt;Removed the invocation context from the response context if present to protect against this kind of issue.&lt;/p&gt;

&lt;p&gt;Additionally, removed the code for logging the response context to avoid revealing potentially sensitive information.&lt;/p&gt;
</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>244763</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 45 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i05ton:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>31906</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>