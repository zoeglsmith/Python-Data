<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Sat May 27 09:48:43 UTC 2023

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CXF-6642] Memory Leak in ResponseImpl.readEntity()</title>
                <link>https://issues.apache.org/jira/browse/CXF-6642</link>
                <project id="12310511" key="CXF">CXF</project>
                    <description>&lt;p&gt;Massive number of ResponseImpl instances are not garbage collected after calling readEntity.  By looking at VisualVM, it seems like those are indirectly referred by something stored in ThreadLocal which is used by context resolving and never been removed after all.   Our production instance actually caused OutOfMemory errors after this.   It might be related to &lt;a href=&quot;https://issues.apache.org/jira/browse/CXF-6458&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CXF-6458&lt;/a&gt; and looks simiar to &lt;a href=&quot;https://java.net/jira/browse/JERSEY-2463&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://java.net/jira/browse/JERSEY-2463&lt;/a&gt; but not sure.  Note this only happens when I used thread pool.&lt;br/&gt;
My workaround was bypassing readEntity() and deal with inputstream directly like following which is not quite desirable but works for now.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; Response copy(Response response) {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Optional.ofNullable(response)
                .map(r -&amp;gt; r.getEntity())
                .filter(e -&amp;gt; e &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; InputStream)
                .map(is -&amp;gt; newResponse(response.getStatus(), (InputStream)is))
                .orElse(response);
    }

    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; Response newResponse(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; status, InputStream is) {
        Response response = Response.serverError().build();
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; payload = IOUtils.toString(is);
            response = Response.status(status).entity(payload).build();
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
            log.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Failed to read entity from response&quot;&lt;/span&gt;, e);
        } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                is.close();
            } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) {
                log.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Failed to close InputStream after reading entity from response&quot;&lt;/span&gt;, e);
            }
        }
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; response;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;Mac OS X 10.10.5, Spring 4.2.0&lt;/p&gt;</environment>
        <key id="12905028">CXF-6642</key>
            <summary>Memory Leak in ResponseImpl.readEntity()</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="2" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Critical</priority>
                        <status id="6" iconUrl="https://issues.apache.org/jira/images/icons/statuses/closed.png" description="The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.">Closed</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sergey_beryozkin">Sergey Beryozkin</assignee>
                                    <reporter username="violkim">Chester Kim</reporter>
                        <labels>
                            <label>client</label>
                            <label>cxf</label>
                    </labels>
                <created>Wed, 14 Oct 2015 21:58:16 +0000</created>
                <updated>Fri, 14 Oct 2016 14:12:26 +0000</updated>
                            <resolved>Thu, 15 Oct 2015 14:08:40 +0000</resolved>
                                    <version>3.1.2</version>
                    <version>3.1.3</version>
                                    <fixVersion>3.0.7</fixVersion>
                    <fixVersion>3.1.4</fixVersion>
                                    <component>JAX-RS</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14958670" author="sergey_beryozkin" created="Thu, 15 Oct 2015 10:16:05 +0000"  >&lt;p&gt;Can you clarify please, &quot;Note this only happens when I used thread pool.&quot;, what does it mean ? &lt;/p&gt;

&lt;p&gt;And if you do not use a thread pool then Response.readEntity() causes no leaks ?&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;</comment>
                            <comment id="14958952" author="sergey_beryozkin" created="Thu, 15 Oct 2015 14:04:00 +0000"  >&lt;p&gt;never mind, see&lt;br/&gt;
&lt;a href=&quot;http://git-wip-us.apache.org/repos/asf/cxf/commit/0430e775&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://git-wip-us.apache.org/repos/asf/cxf/commit/0430e775&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The simpler solution is to have immediate typed reads, ex, client.get(Book.class) as opposed to client.get().readEntity(Book.class) - in the former case Response.readEntity is also used by TLS is cleaned up, which was not the case with a direct use of readEntity.&lt;/p&gt;

&lt;p&gt;Thanks &lt;/p&gt;</comment>
                            <comment id="14959170" author="violkim" created="Thu, 15 Oct 2015 16:27:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sergeyb&quot; class=&quot;user-hover&quot; rel=&quot;sergeyb&quot;&gt;sergeyb&lt;/a&gt; Yes.  The leakage doesn&apos;t happen when I didn&apos;t use threadpool (serviceexecutor).  It seems like CXF uses Spring to resolve the context which always store things in ThreadLocal of a task in its own threadpool.   Also, it&apos;s not only problem with GET method.  We&apos;re using JAX-RS 2 client api for all of GET/HEAD/PUT/POST/DELETE.  So, your suggested solution might not be a case for others, does it?&lt;/p&gt;

&lt;p&gt;I&apos;ll definitely try the fix when 3.1.4 comes out.&lt;br/&gt;
Thanks!&lt;/p&gt;</comment>
                            <comment id="14959181" author="sergey_beryozkin" created="Thu, 15 Oct 2015 16:34:08 +0000"  >&lt;p&gt;client.get(Book.class) should be safe right now. &lt;/p&gt;</comment>
                            <comment id="14959195" author="sergey_beryozkin" created="Thu, 15 Oct 2015 16:42:44 +0000"  >&lt;p&gt;You might want to try 3.1.4-SNAPSHT in few days &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14959209" author="violkim" created="Thu, 15 Oct 2015 16:47:14 +0000"  >&lt;p&gt;By using client.get(XXX.class), we have no visibility to the status code or any other properties of Response, right?&lt;/p&gt;</comment>
                            <comment id="14959586" author="sergey_beryozkin" created="Thu, 15 Oct 2015 20:45:26 +0000"  >&lt;p&gt;Not with 2.0 API, only with WebClient: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Book b = wc.get(Book.class);
Response r = wc.getResponse();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12310060" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Estimated Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10060"><![CDATA[Unknown]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 33 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2n16v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </customfields>
    </item>
</channel>
</rss>